#!/bin/bash
set -euo pipefail

API_PRIVATE_IP="${api_private_ip}"

exec > >(tee /var/log/user-data.log) 2>&1

echo "[INFO] start web init script"

if [ -z "$${API_PRIVATE_IP}" ]; then
  echo "[ERROR] API_PRIVATE_IP is empty"
  exit 1
fi

dnf -y update
dnf -y install dnf-plugins-core curl git
dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
dnf -y install docker-ce docker-ce-cli containerd.io
systemctl enable --now docker

mkdir -p /opt/external/web

echo "PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0iVVRGLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xLjAiIC8+CiAgPHRpdGxlPkJpZyBEYXRhIENvbnZlcmdlbmNlIENhbXB1cyB8IENlcnRpZmljYXRlIExvb2t1cDwvdGl0bGU+CiAgPGxpbmsgcmVsPSJwcmVjb25uZWN0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tIj4KICA8bGluayByZWw9InByZWNvbm5lY3QiIGhyZWY9Imh0dHBzOi8vZm9udHMuZ3N0YXRpYy5jb20iIGNyb3Nzb3JpZ2luPgogIDxsaW5rIGhyZWY9Imh0dHBzOi8vZm9udHMuZ29vZ2xlYXBpcy5jb20vY3NzMj9mYW1pbHk9TmFudW0rR290aGljOndnaHRANDAwOzcwMDs4MDAmZmFtaWx5PU1vbnRzZXJyYXQ6d2dodEA2MDA7NzAwJmRpc3BsYXk9c3dhcCIgcmVsPSJzdHlsZXNoZWV0Ij4KICA8c3R5bGU+CiAgICA6cm9vdCB7CiAgICAgIC0tYmctMTogI2VlZjZmZjsKICAgICAgLS1iZy0yOiAjZGNlY2ZmOwogICAgICAtLWluazogIzBmMWYzYTsKICAgICAgLS1tdXRlZDogIzRmNjY4ODsKICAgICAgLS1wcmltYXJ5OiAjMDA2NmQ2OwogICAgICAtLXByaW1hcnktMjogIzBiNGNhODsKICAgICAgLS1wYW5lbDogI2ZmZmZmZjsKICAgICAgLS1saW5lOiAjZDdlNGY2OwogICAgICAtLXRoOiAjZWRmM2ZiOwogICAgfQoKICAgICogeyBib3gtc2l6aW5nOiBib3JkZXItYm94OyB9CgogICAgYm9keSB7CiAgICAgIG1hcmdpbjogMDsKICAgICAgbWluLWhlaWdodDogMTAwdmg7CiAgICAgIGNvbG9yOiB2YXIoLS1pbmspOwogICAgICBmb250LWZhbWlseTogIk5hbnVtIEdvdGhpYyIsIHNhbnMtc2VyaWY7CiAgICAgIGJhY2tncm91bmQ6CiAgICAgICAgcmFkaWFsLWdyYWRpZW50KGNpcmNsZSBhdCAxMCUgLTEwJSwgcmdiYSgwLCAxMDIsIDIxNCwgMC4yKSwgdHJhbnNwYXJlbnQgMzUlKSwKICAgICAgICByYWRpYWwtZ3JhZGllbnQoY2lyY2xlIGF0IDk1JSAyMCUsIHJnYmEoMTEsIDc2LCAxNjgsIDAuMTgpLCB0cmFuc3BhcmVudCA0MCUpLAogICAgICAgIGxpbmVhci1ncmFkaWVudCgxNjBkZWcsIHZhcigtLWJnLTEpLCB2YXIoLS1iZy0yKSk7CiAgICB9CgogICAgLndyYXAgewogICAgICBtYXgtd2lkdGg6IDExMjBweDsKICAgICAgbWFyZ2luOiA0MHB4IGF1dG87CiAgICAgIHBhZGRpbmc6IDAgMjBweDsKICAgIH0KCiAgICAuaGVybyB7CiAgICAgIGJhY2tncm91bmQ6IGxpbmVhci1ncmFkaWVudCgxMzVkZWcsICMwYzJkNjYsICMwYTRlYTgpOwogICAgICBjb2xvcjogI2ZmZjsKICAgICAgYm9yZGVyLXJhZGl1czogMjBweDsKICAgICAgcGFkZGluZzogMjhweCAzMHB4OwogICAgICBib3gtc2hhZG93OiAwIDE0cHggMzZweCByZ2JhKDYsIDM1LCA4NSwgMC4yNik7CiAgICAgIGFuaW1hdGlvbjogZmFkZUluIDUwMG1zIGVhc2Utb3V0OwogICAgfQoKICAgIC5raWNrZXIgewogICAgICBmb250LWZhbWlseTogIk1vbnRzZXJyYXQiLCBzYW5zLXNlcmlmOwogICAgICBmb250LXdlaWdodDogNzAwOwogICAgICBsZXR0ZXItc3BhY2luZzogMC4wOGVtOwogICAgICBmb250LXNpemU6IDEycHg7CiAgICAgIG9wYWNpdHk6IDAuODU7CiAgICAgIHRleHQtdHJhbnNmb3JtOiB1cHBlcmNhc2U7CiAgICAgIG1hcmdpbi1ib3R0b206IDhweDsKICAgIH0KCiAgICBoMSB7CiAgICAgIG1hcmdpbjogMDsKICAgICAgZm9udC1zaXplOiBjbGFtcCgzMHB4LCA1dncsIDQ0cHgpOwogICAgICBmb250LXdlaWdodDogODAwOwogICAgICBsaW5lLWhlaWdodDogMS4xNDsKICAgIH0KCiAgICAuc3ViIHsKICAgICAgbWFyZ2luOiAxMHB4IDAgMDsKICAgICAgY29sb3I6ICNkOGU4ZmY7CiAgICAgIGZvbnQtc2l6ZTogMTVweDsKICAgIH0KCiAgICAucGFuZWwgewogICAgICBtYXJnaW4tdG9wOiAxOHB4OwogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1wYW5lbCk7CiAgICAgIGJvcmRlcjogMXB4IHNvbGlkIHZhcigtLWxpbmUpOwogICAgICBib3JkZXItcmFkaXVzOiAxOHB4OwogICAgICBwYWRkaW5nOiAyMnB4OwogICAgICBib3gtc2hhZG93OiAwIDEwcHggMjhweCByZ2JhKDExLCA0NiwgOTUsIDAuMTQpOwogICAgICBhbmltYXRpb246IHJpc2VJbiA2MDBtcyBlYXNlLW91dDsKICAgIH0KCiAgICAuYWN0aW9ucyB7CiAgICAgIGRpc3BsYXk6IGZsZXg7CiAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgIGdhcDogMTJweDsKICAgICAgbWFyZ2luLWJvdHRvbTogMTRweDsKICAgICAgZmxleC13cmFwOiB3cmFwOwogICAgfQoKICAgIGJ1dHRvbiB7CiAgICAgIGJvcmRlcjogbm9uZTsKICAgICAgYmFja2dyb3VuZDogbGluZWFyLWdyYWRpZW50KDEzNWRlZywgdmFyKC0tcHJpbWFyeSksIHZhcigtLXByaW1hcnktMikpOwogICAgICBjb2xvcjogI2ZmZjsKICAgICAgcGFkZGluZzogMTFweCAxOHB4OwogICAgICBib3JkZXItcmFkaXVzOiAxMnB4OwogICAgICBmb250LXNpemU6IDE1cHg7CiAgICAgIGZvbnQtd2VpZ2h0OiA3MDA7CiAgICAgIGN1cnNvcjogcG9pbnRlcjsKICAgICAgYm94LXNoYWRvdzogMCA4cHggMjBweCByZ2JhKDAsIDgyLCAxODAsIDAuMyk7CiAgICAgIHRyYW5zaXRpb246IHRyYW5zZm9ybSAxMjBtcyBlYXNlLCBmaWx0ZXIgMTIwbXMgZWFzZTsKICAgIH0KCiAgICBidXR0b246aG92ZXIgeyBmaWx0ZXI6IGJyaWdodG5lc3MoMS4wNCk7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgtMXB4KTsgfQogICAgYnV0dG9uOmFjdGl2ZSB7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgYnV0dG9uOmRpc2FibGVkIHsgb3BhY2l0eTogMC43NTsgY3Vyc29yOiB3YWl0OyB9CgogICAgLm11dGVkIHsKICAgICAgbWFyZ2luOiAwOwogICAgICBjb2xvcjogdmFyKC0tbXV0ZWQpOwogICAgICBmb250LXNpemU6IDE0cHg7CiAgICB9CgogICAgLnRhYmxlLXdyYXAgewogICAgICBvdmVyZmxvdy14OiBhdXRvOwogICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1saW5lKTsKICAgICAgYm9yZGVyLXJhZGl1czogMTRweDsKICAgIH0KCiAgICB0YWJsZSB7CiAgICAgIHdpZHRoOiAxMDAlOwogICAgICBib3JkZXItY29sbGFwc2U6IGNvbGxhcHNlOwogICAgICBtaW4td2lkdGg6IDcyMHB4OwogICAgICBiYWNrZ3JvdW5kOiAjZmZmOwogICAgfQoKICAgIHRoLCB0ZCB7CiAgICAgIHBhZGRpbmc6IDEzcHggMTRweDsKICAgICAgdGV4dC1hbGlnbjogbGVmdDsKICAgICAgYm9yZGVyLWJvdHRvbTogMXB4IHNvbGlkIHZhcigtLWxpbmUpOwogICAgICBmb250LXNpemU6IDE1cHg7CiAgICB9CgogICAgdGggewogICAgICBiYWNrZ3JvdW5kOiB2YXIoLS10aCk7CiAgICAgIGZvbnQtd2VpZ2h0OiA4MDA7CiAgICAgIGNvbG9yOiAjMTgzNDVlOwogICAgfQoKICAgIHRib2R5IHRyOm50aC1jaGlsZChldmVuKSB7IGJhY2tncm91bmQ6ICNmOWZiZmY7IH0KICAgIHRib2R5IHRyOmhvdmVyIHsgYmFja2dyb3VuZDogI2VlZjVmZjsgfQoKICAgIEBtZWRpYSAobWF4LXdpZHRoOiA3MjBweCkgewogICAgICAud3JhcCB7IG1hcmdpbjogMjBweCBhdXRvOyB9CiAgICAgIC5oZXJvIHsgcGFkZGluZzogMjJweCAyMHB4OyBib3JkZXItcmFkaXVzOiAxNnB4OyB9CiAgICAgIC5wYW5lbCB7IHBhZGRpbmc6IDE2cHg7IGJvcmRlci1yYWRpdXM6IDE0cHg7IH0KICAgICAgdGgsIHRkIHsgZm9udC1zaXplOiAxNHB4OyBwYWRkaW5nOiAxMXB4IDEwcHg7IH0KICAgIH0KCiAgICBAa2V5ZnJhbWVzIGZhZGVJbiB7CiAgICAgIGZyb20geyBvcGFjaXR5OiAwOyB0cmFuc2Zvcm06IHRyYW5zbGF0ZVkoOHB4KTsgfQogICAgICB0byB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgfQoKICAgIEBrZXlmcmFtZXMgcmlzZUluIHsKICAgICAgZnJvbSB7IG9wYWNpdHk6IDA7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgxMnB4KTsgfQogICAgICB0byB7IG9wYWNpdHk6IDE7IHRyYW5zZm9ybTogdHJhbnNsYXRlWSgwKTsgfQogICAgfQogIDwvc3R5bGU+CjwvaGVhZD4KPGJvZHk+CiAgPG1haW4gY2xhc3M9IndyYXAiPgogICAgPHNlY3Rpb24gY2xhc3M9Imhlcm8iPgogICAgICA8cCBjbGFzcz0ia2lja2VyIj5CaWcgRGF0YSBDb252ZXJnZW5jZSBDYW1wdXM8L3A+CiAgICAgIDxoMT5CaWcgRGF0YSBDb252ZXJnZW5jZSBDYW1wdXM8YnIvPkNlcnRpZmljYXRlIExvb2t1cDwvaDE+CiAgICAgIDxwIGNsYXNzPSJzdWIiPlZpZXcgQ09TUyBjZXJ0aWZpY2F0ZSByZWNvcmRzIGZyb20gdGhlIGV4dGVybmFsIHBvcnRhbC48L3A+CiAgICA8L3NlY3Rpb24+CgogICAgPHNlY3Rpb24gY2xhc3M9InBhbmVsIj4KICAgICAgPGRpdiBjbGFzcz0iYWN0aW9ucyI+CiAgICAgICAgPGJ1dHRvbiBpZD0ibG9hZEJ0biIgdHlwZT0iYnV0dG9uIj5Mb2FkIENlcnRpZmljYXRlczwvYnV0dG9uPgogICAgICAgIDxwIGNsYXNzPSJtdXRlZCI+Q2xpY2sgYnV0dG9uIHRvIGNhbGwgL2FwaS9jZXJ0aWZpY2F0ZXM8L3A+CiAgICAgIDwvZGl2PgoKICAgICAgPGRpdiBjbGFzcz0idGFibGUtd3JhcCI+CiAgICAgICAgPHRhYmxlIGlkPSJjZXJ0VGFibGUiPgogICAgICAgICAgPHRoZWFkPgogICAgICAgICAgICA8dHI+CiAgICAgICAgICAgICAgPHRoPnNlcmlhbE51bWJlcjwvdGg+CiAgICAgICAgICAgICAgPHRoPmxlY3R1cmVJZDwvdGg+CiAgICAgICAgICAgICAgPHRoPnVzZXJJZDwvdGg+CiAgICAgICAgICAgICAgPHRoPmlzc3VlZEF0PC90aD4KICAgICAgICAgICAgPC90cj4KICAgICAgICAgIDwvdGhlYWQ+CiAgICAgICAgICA8dGJvZHk+PC90Ym9keT4KICAgICAgICA8L3RhYmxlPgogICAgICA8L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L21haW4+CgogIDxzY3JpcHQ+CiAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZEJ0bicpOwogICAgY29uc3QgdGJvZHkgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjY2VydFRhYmxlIHRib2R5Jyk7CgogICAgZnVuY3Rpb24gcmVuZGVyUm93cyhpdGVtcykgewogICAgICB0Ym9keS5pbm5lckhUTUwgPSAnJzsKICAgICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHsKICAgICAgICBjb25zdCB0ciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RyJyk7CiAgICAgICAgdHIuaW5uZXJIVE1MID0gYAogICAgICAgICAgPHRkPiR7aXRlbS5zZXJpYWxOdW1iZXIgPz8gJyd9PC90ZD4KICAgICAgICAgIDx0ZD4ke2l0ZW0ubGVjdHVyZUlkID8/ICcnfTwvdGQ+CiAgICAgICAgICA8dGQ+JHtpdGVtLnVzZXJJZCA/PyAnJ308L3RkPgogICAgICAgICAgPHRkPiR7aXRlbS5pc3N1ZWRBdCA/PyAnJ308L3RkPgogICAgICAgIGA7CiAgICAgICAgdGJvZHkuYXBwZW5kQ2hpbGQodHIpOwogICAgICB9KTsKICAgIH0KCiAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IG9yaWdpbmFsVGV4dCA9IGJ0bi50ZXh0Q29udGVudDsKICAgICAgYnRuLmRpc2FibGVkID0gdHJ1ZTsKICAgICAgYnRuLnRleHRDb250ZW50ID0gJ0xvYWRpbmcuLi4nOwogICAgICB0cnkgewogICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKCcvYXBpL2NlcnRpZmljYXRlcycsIHsgbWV0aG9kOiAnR0VUJyB9KTsKICAgICAgICBpZiAoIXJlcy5vaykgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdIVFRQICcgKyByZXMuc3RhdHVzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IHJlcy5qc29uKCk7CiAgICAgICAgcmVuZGVyUm93cyhBcnJheS5pc0FycmF5KGRhdGEpID8gZGF0YSA6IFtdKTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgYWxlcnQoJ0xvYWQgZmFpbGVkOiAnICsgZXJyLm1lc3NhZ2UpOwogICAgICB9IGZpbmFsbHkgewogICAgICAgIGJ0bi5kaXNhYmxlZCA9IGZhbHNlOwogICAgICAgIGJ0bi50ZXh0Q29udGVudCA9IG9yaWdpbmFsVGV4dDsKICAgICAgfQogICAgfSk7CiAgPC9zY3JpcHQ+CjwvYm9keT4KPC9odG1sPg0K" | base64 -d > /opt/external/web/index.html

printf '%s\n' \
  'server {' \
  '    listen 80;' \
  '    server_name _;' \
  '' \
  '    location / {' \
  '        root /usr/share/nginx/html;' \
  '        index index.html;' \
  '        try_files $uri $uri/ /index.html;' \
  '    }' \
  '' \
  '    location /api/ {' \
  '        proxy_http_version 1.1;' \
  '        proxy_set_header Host $host;' \
  '        proxy_set_header X-Real-IP $remote_addr;' \
  '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
  '        proxy_set_header X-Forwarded-Proto $scheme;' \
  "        proxy_pass http://$${API_PRIVATE_IP}:8080;" \
  '    }' \
  '}' > /opt/external/web/default.conf

docker rm -f external-web 2>/dev/null || true
docker run -d \
  --name external-web \
  --restart always \
  -p 80:80 \
  -v /opt/external/web/index.html:/usr/share/nginx/html/index.html:ro \
  -v /opt/external/web/default.conf:/etc/nginx/conf.d/default.conf:ro \
  nginx:stable-alpine

echo "[INFO] web container started"
echo "[INFO] web init script complete"
