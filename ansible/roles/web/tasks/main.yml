---
- name: Ensure web app directory exists
  ansible.builtin.file:
    path: /opt/external/web
    state: directory
    mode: "0755"

- name: Deploy web index
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../../apps/web/index.html"
    dest: /opt/external/web/index.html
    mode: "0644"

- name: Render nginx config
  ansible.builtin.template:
    src: nginx.conf.template
    dest: /opt/external/web/default.conf
    mode: "0644"
  notify: Reload nginx in web container

- name: Run web container
  community.docker.docker_container:
    name: external-web
    image: "{{ web_image_name }}"
    recreate: "{{ web_container_recreate | bool }}"
    state: started
    restart_policy: always
    ports:
      - "80:80"
    volumes:
      - /opt/external/web/index.html:/usr/share/nginx/html/index.html:ro
      - /opt/external/web/default.conf:/etc/nginx/conf.d/default.conf:ro
